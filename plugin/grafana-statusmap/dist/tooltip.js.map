{"version":3,"sources":["../src/tooltip.js"],"names":["d3","$","_","kbn","TOOLTIP_PADDING_X","TOOLTIP_PADDING_Y","StatusHeatmapTooltip","elem","scope","dashboard","ctrl","panelCtrl","panel","heatmapPanel","mouseOverBucket","originalFillColor","on","onMouseOver","bind","onMouseLeave","e","tooltip","show","data","isEmpty","add","move","destroy","select","append","attr","remove","pos","panelRelY","cardId","target","card","cardsData","cards","x","y","value","values","tooltipTimeFormat","time","formatDate","tooltipHtml","color","mode","statuses","discreteHelper","convertValuesToTooltips","statusesHtml","length","join","map","v","useMax","multipleValues","dataWarnings","title","noColorDefined","badValues","getNotColoredValues","html","node","tooltipWidth","clientWidth","tooltipHeight","clientHeight","left","pageX","top","pageY","window","innerWidth","pageYOffset","innerHeight","style"],"mappings":"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","file":"tooltip.js","sourcesContent":["import d3 from 'd3';\nimport $ from 'jquery';\nimport _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\n\nlet TOOLTIP_PADDING_X = 30;\nlet TOOLTIP_PADDING_Y = 5;\n\nexport class StatusHeatmapTooltip {\n  constructor(elem, scope) {\n    this.scope = scope;\n    this.dashboard = scope.ctrl.dashboard;\n    this.panelCtrl = scope.ctrl;\n    this.panel = scope.ctrl.panel;\n    this.heatmapPanel = elem;\n    this.mouseOverBucket = false;\n    this.originalFillColor = null;\n\n    elem.on(\"mouseover\", this.onMouseOver.bind(this));\n    elem.on(\"mouseleave\", this.onMouseLeave.bind(this));\n  }\n\n  onMouseOver(e) {\n    if (!this.panel.tooltip.show || !this.scope.ctrl.data || _.isEmpty(this.scope.ctrl.data)) { return; }\n\n    if (!this.tooltip) {\n      this.add();\n      this.move(e);\n    }\n  }\n\n  onMouseLeave() {\n    this.destroy();\n  }\n\n  onMouseMove(e) {\n    if (!this.panel.tooltip.show) { return; }\n\n    this.move(e);\n  }\n\n  add() {\n    this.tooltip = d3.select(\"body\")\n      .append(\"div\")\n      .attr(\"class\", \"statusmap-tooltip graph-tooltip grafana-tooltip\");\n  }\n\n  destroy() {\n    if (this.tooltip) {\n      this.tooltip.remove();\n    }\n\n    this.tooltip = null;\n  }\n\n  show(pos) {\n    if (!this.panel.tooltip.show || !this.tooltip) { return; }\n    // shared tooltip mode\n    if (pos.panelRelY) {\n      return;\n    }\n    let cardId = d3.select(pos.target).attr('cardId');\n    if (!cardId) {\n      this.destroy();\n      return;\n    }\n\n    let card = this.panelCtrl.cardsData.cards[cardId];\n    if (!card) {\n      this.destroy();\n      return;\n    }\n\n    let x = card.x;\n    let y = card.y;\n    let value = card.value;\n    let values = card.values;\n    let tooltipTimeFormat = 'YYYY-MM-DD HH:mm:ss';\n    let time = this.dashboard.formatDate(+x, tooltipTimeFormat);\n\n    let tooltipHtml = `<div class=\"graph-tooltip-time\">${time}</div>\n      <div class=\"statusmap-histogram\"></div>`;\n\n    if (this.panel.color.mode === 'discrete') {\n      let statuses = this.panelCtrl.discreteHelper.convertValuesToTooltips(values);\n      let statusesHtml = '';\n      if (statuses.length === 1) {\n        statusesHtml = \"status:\";\n      } else if (statuses.length > 1) {\n        statusesHtml = \"statuses:\";\n      }\n      tooltipHtml += `\n      <div>\n        name: <b>${y}</b> <br>\n        ${statusesHtml}\n        <ul>\n          ${_.join(_.map(statuses, v => `<li style=\"background-color: ${v.color}\" class=\"discrete-item\">${v.tooltip}</li>`), \"\")}\n        </ul>\n      </div>`;\n    } else {\n      if (values.length === 1) {\n        tooltipHtml += `<div> \n      name: <b>${y}</b> <br>\n      value: <b>${value}</b> <br>\n      </div>`;\n      } else {\n        tooltipHtml += `<div>\n      name: <b>${y}</b> <br>\n      values:\n      <ul>\n        ${_.join(_.map(values, v => `<li>${v}</li>`), \"\")}\n      </ul>\n      </div>`;\n      }\n    }\n\n    //   \"Ambiguous bucket state: Multiple values!\";\n    if (!this.panel.useMax && card.multipleValues) {\n      tooltipHtml += `<div><b>Error:</b> ${this.panelCtrl.dataWarnings.multipleValues.title}</div>`;\n    }\n\n    // Discrete mode errors\n    if (this.panel.color.mode === 'discrete') {\n      if (card.noColorDefined) {\n        let badValues = this.panelCtrl.discreteHelper.getNotColoredValues(values);\n        tooltipHtml += `<div><b>Error:</b> ${this.panelCtrl.dataWarnings.noColorDefined.title}\n        <br>not colored values:\n        <ul>\n          ${_.join(_.map(badValues, v => `<li>${v}</li>`), \"\")}\n        </ul>\n        </div>`;\n\n      }\n    }\n\n    this.tooltip.html(tooltipHtml);\n\n    this.move(pos);\n  }\n\n  move(pos) {\n    if (!this.tooltip) { return; }\n\n    let elem = $(this.tooltip.node())[0];\n    let tooltipWidth = elem.clientWidth;\n    let tooltipHeight = elem.clientHeight;\n\n    let left = pos.pageX + TOOLTIP_PADDING_X;\n    let top = pos.pageY + TOOLTIP_PADDING_Y;\n\n    if (pos.pageX + tooltipWidth + 40 > window.innerWidth) {\n      left = pos.pageX - tooltipWidth - TOOLTIP_PADDING_X;\n    }\n\n    if (pos.pageY - window.pageYOffset + tooltipHeight + 20 > window.innerHeight) {\n      top = pos.pageY - tooltipHeight - TOOLTIP_PADDING_Y;\n    }\n\n    return this.tooltip\n      .style(\"left\", left + \"px\")\n      .style(\"top\", top + \"px\");\n  }\n}\n"]}