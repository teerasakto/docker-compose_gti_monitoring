{"version":3,"sources":["../../src/datasource-zabbix/zabbixAPI.service.js"],"names":["ZabbixAPIServiceFactory","alertSrv","zabbixAPICoreService","ZabbixAPI","api_url","username","password","basicAuth","withCredentials","url","auth","requestOptions","loginPromise","loginErrorCount","maxLoginAttempts","zabbixAPICore","getTrend","getTrend_ZBXNEXT1193","method","params","request","catch","isNotAuthorized","error","data","loginOnce","then","message","statusText","alertAPIError","timeout","set","Promise","resolve","login","getVersion","eventid","eventids","output","sortfield","real_hosts","groupids","hostids","appids","itemtype","webitems","filter","selectHosts","applicationids","value_type","utils","expandItems","itemids","globalmacro","itemid","items","length","lastvalue","timeFrom","timeTill","grouped_items","_","groupBy","promises","map","history","sortorder","time_from","time_till","all","flatten","trend","self","serviceids","timeRange","timeTo","intervals","from","to","options","showTriggers","maintenance","expandDescription","expandData","expandComment","monitored","skipDependent","value","selectGroups","selectItems","selectLastEvent","selectTags","lastChangeSince","lastChangeTill","objectids","showEvents","select_acknowledges","preservekeys","events","event","acknowledges","minSeverity","acknowledged","count","min_severity","countOutput","triggers","filterTriggersByAcknowledge","trigger","lastEvent","angular","module","factory"],"mappings":"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","file":"zabbixAPI.service.js","sourcesContent":["import angular from 'angular';\nimport _ from 'lodash';\nimport * as utils from './utils';\nimport './zabbixAPICore.service';\n\n/** @ngInject */\nfunction ZabbixAPIServiceFactory(alertSrv, zabbixAPICoreService) {\n\n  /**\n   * Zabbix API Wrapper.\n   * Creates Zabbix API instance with given parameters (url, credentials and other).\n   * Wraps API calls and provides high-level methods.\n   */\n  class ZabbixAPI {\n\n    constructor(api_url, username, password, basicAuth, withCredentials) {\n      this.url              = api_url;\n      this.username         = username;\n      this.password         = password;\n      this.auth             = \"\";\n\n      this.requestOptions = {\n        basicAuth: basicAuth,\n        withCredentials: withCredentials\n      };\n\n      this.loginPromise = null;\n      this.loginErrorCount = 0;\n      this.maxLoginAttempts = 3;\n\n      this.alertSrv = alertSrv;\n      this.zabbixAPICore = zabbixAPICoreService;\n\n      this.getTrend = this.getTrend_ZBXNEXT1193;\n      //getTrend = getTrend_30;\n    }\n\n    //////////////////////////\n    // Core method wrappers //\n    //////////////////////////\n\n    request(method, params) {\n      return this.zabbixAPICore.request(this.url, method, params, this.requestOptions, this.auth)\n      .catch(error => {\n        if (isNotAuthorized(error.data)) {\n          // Handle auth errors\n          this.loginErrorCount++;\n          if (this.loginErrorCount > this.maxLoginAttempts) {\n            this.loginErrorCount = 0;\n            return null;\n          } else {\n            return this.loginOnce()\n            .then(() => this.request(method, params));\n          }\n        } else {\n          // Handle API errors\n          let message = error.data ? error.data : error.statusText;\n          this.alertAPIError(message);\n        }\n      });\n    }\n\n    alertAPIError(message, timeout = 5000) {\n      this.alertSrv.set(\n        \"Zabbix API Error\",\n        message,\n        'error',\n        timeout\n      );\n    }\n\n    /**\n     * When API unauthenticated or auth token expired each request produce login()\n     * call. But auth token is common to all requests. This function wraps login() method\n     * and call it once. If login() already called just wait for it (return its promise).\n     * @return login promise\n     */\n    loginOnce() {\n      if (!this.loginPromise) {\n        this.loginPromise = Promise.resolve(\n          this.login().then(auth => {\n            this.auth = auth;\n            this.loginPromise = null;\n            return auth;\n          })\n        );\n      }\n      return this.loginPromise;\n    }\n\n    /**\n     * Get authentication token.\n     */\n    login() {\n      return this.zabbixAPICore.login(this.url, this.username, this.password, this.requestOptions);\n    }\n\n    /**\n     * Get Zabbix API version\n     */\n    getVersion() {\n      return this.zabbixAPICore.getVersion(this.url, this.requestOptions);\n    }\n\n    ////////////////////////////////\n    // Zabbix API method wrappers //\n    ////////////////////////////////\n\n    acknowledgeEvent(eventid, message) {\n      var params = {\n        eventids: eventid,\n        message: message\n      };\n\n      return this.request('event.acknowledge', params);\n    }\n\n    getGroups() {\n      var params = {\n        output: ['name'],\n        sortfield: 'name',\n        real_hosts: true\n      };\n\n      return this.request('hostgroup.get', params);\n    }\n\n    getHosts(groupids) {\n      var params = {\n        output: ['name', 'host'],\n        sortfield: 'name'\n      };\n      if (groupids) {\n        params.groupids = groupids;\n      }\n\n      return this.request('host.get', params);\n    }\n\n    getApps(hostids) {\n      var params = {\n        output: 'extend',\n        hostids: hostids\n      };\n\n      return this.request('application.get', params);\n    }\n\n    /**\n     * Get Zabbix items\n     * @param  {[type]} hostids  host ids\n     * @param  {[type]} appids   application ids\n     * @param  {String} itemtype 'num' or 'text'\n     * @return {[type]}          array of items\n     */\n    getItems(hostids, appids, itemtype) {\n      var params = {\n        output: [\n          'name', 'key_',\n          'value_type',\n          'hostid',\n          'status',\n          'state'\n        ],\n        sortfield: 'name',\n        webitems: true,\n        filter: {},\n        selectHosts: ['hostid', 'name']\n      };\n      if (hostids) {\n        params.hostids = hostids;\n      }\n      if (appids) {\n        params.applicationids = appids;\n      }\n      if (itemtype === 'num') {\n        // Return only numeric metrics\n        params.filter.value_type = [0, 3];\n      }\n      if (itemtype === 'text') {\n        // Return only text metrics\n        params.filter.value_type = [1, 2, 4];\n      }\n\n      return this.request('item.get', params)\n      .then(utils.expandItems);\n    }\n\n    getItemsByIDs(itemids) {\n      var params = {\n        itemids: itemids,\n        output: [\n          'name', 'key_',\n          'value_type',\n          'hostid',\n          'status',\n          'state'\n        ],\n        webitems: true,\n        selectHosts: ['hostid', 'name']\n      };\n\n      return this.request('item.get', params)\n      .then(utils.expandItems);\n    }\n\n    getMacros(hostids) {\n      var params = {\n        output: 'extend',\n        hostids: hostids\n      };\n\n      return this.request('usermacro.get', params);\n    }\n\n    getGlobalMacros() {\n      var params = {\n        output: 'extend',\n        globalmacro: true\n      };\n\n      return this.request('usermacro.get', params);\n    }\n\n    getLastValue(itemid) {\n      var params = {\n        output: ['lastvalue'],\n        itemids: itemid\n      };\n      return this.request('item.get', params)\n      .then(items => items.length ? items[0].lastvalue : null);\n    }\n\n    /**\n     * Perform history query from Zabbix API\n     *\n     * @param  {Array}  items       Array of Zabbix item objects\n     * @param  {Number} timeFrom   Time in seconds\n     * @param  {Number} timeTill   Time in seconds\n     * @return {Array}  Array of Zabbix history objects\n     */\n    getHistory(items, timeFrom, timeTill) {\n\n      // Group items by value type and perform request for each value type\n      let grouped_items = _.groupBy(items, 'value_type');\n      let promises = _.map(grouped_items, (items, value_type) => {\n        let itemids = _.map(items, 'itemid');\n        let params = {\n          output: 'extend',\n          history: value_type,\n          itemids: itemids,\n          sortfield: 'clock',\n          sortorder: 'ASC',\n          time_from: timeFrom\n        };\n\n        // Relative queries (e.g. last hour) don't include an end time\n        if (timeTill) {\n          params.time_till = timeTill;\n        }\n\n        return this.request('history.get', params);\n      });\n\n      return Promise.all(promises).then(_.flatten);\n    }\n\n    /**\n     * Perform trends query from Zabbix API\n     * Use trends api extension from ZBXNEXT-1193 patch.\n     *\n     * @param  {Array}  items       Array of Zabbix item objects\n     * @param  {Number} time_from   Time in seconds\n     * @param  {Number} time_till   Time in seconds\n     * @return {Array}  Array of Zabbix trend objects\n     */\n    getTrend_ZBXNEXT1193(items, timeFrom, timeTill) {\n\n      // Group items by value type and perform request for each value type\n      let grouped_items = _.groupBy(items, 'value_type');\n      let promises = _.map(grouped_items, (items, value_type) => {\n        let itemids = _.map(items, 'itemid');\n        let params = {\n          output: 'extend',\n          trend: value_type,\n          itemids: itemids,\n          sortfield: 'clock',\n          sortorder: 'ASC',\n          time_from: timeFrom\n        };\n\n        // Relative queries (e.g. last hour) don't include an end time\n        if (timeTill) {\n          params.time_till = timeTill;\n        }\n\n        return this.request('trend.get', params);\n      });\n\n      return Promise.all(promises).then(_.flatten);\n    }\n\n    getTrend_30(items, time_from, time_till, value_type) {\n      var self = this;\n      var itemids = _.map(items, 'itemid');\n\n      var params = {\n        output: [\"itemid\",\n          \"clock\",\n          value_type\n        ],\n        itemids: itemids,\n        time_from: time_from\n      };\n\n      // Relative queries (e.g. last hour) don't include an end time\n      if (time_till) {\n        params.time_till = time_till;\n      }\n\n      return self.request('trend.get', params);\n    }\n\n    getITService(serviceids) {\n      var params = {\n        output: 'extend',\n        serviceids: serviceids\n      };\n      return this.request('service.get', params);\n    }\n\n    getSLA(serviceids, timeRange) {\n      let [timeFrom, timeTo] = timeRange;\n      var params = {\n        serviceids: serviceids,\n        intervals: [{\n          from: timeFrom,\n          to: timeTo\n        }]\n      };\n      return this.request('service.getsla', params);\n    }\n\n    getTriggers(groupids, hostids, applicationids, options) {\n      let {showTriggers, maintenance, timeFrom, timeTo} = options;\n\n      let params = {\n        output: 'extend',\n        groupids: groupids,\n        hostids: hostids,\n        applicationids: applicationids,\n        expandDescription: true,\n        expandData: true,\n        expandComment: true,\n        monitored: true,\n        skipDependent: true,\n        //only_true: true,\n        filter: {\n          value: 1\n        },\n        selectGroups: ['name'],\n        selectHosts: ['name', 'host', 'maintenance_status'],\n        selectItems: ['name', 'key_', 'lastvalue'],\n        selectLastEvent: 'extend',\n        selectTags: 'extend'\n      };\n\n      if (showTriggers) {\n        params.filter.value = showTriggers;\n      }\n\n      if (maintenance) {\n        params.maintenance = true;\n      }\n\n      if (timeFrom || timeTo) {\n        params.lastChangeSince = timeFrom;\n        params.lastChangeTill = timeTo;\n      }\n\n      return this.request('trigger.get', params);\n    }\n\n    getEvents(objectids, timeFrom, timeTo, showEvents) {\n      var params = {\n        output: 'extend',\n        time_from: timeFrom,\n        time_till: timeTo,\n        objectids: objectids,\n        select_acknowledges: 'extend',\n        selectHosts: 'extend',\n        value: showEvents\n      };\n\n      return this.request('event.get', params);\n    }\n\n    getAcknowledges(eventids) {\n      var params = {\n        output: 'extend',\n        eventids: eventids,\n        preservekeys: true,\n        select_acknowledges: 'extend',\n        sortfield: 'clock',\n        sortorder: 'DESC'\n      };\n\n      return this.request('event.get', params)\n      .then(events => {\n        return _.filter(events, (event) => event.acknowledges.length);\n      });\n    }\n\n    getAlerts(itemids, timeFrom, timeTo) {\n      var params = {\n        output: 'extend',\n        itemids: itemids,\n        expandDescription: true,\n        expandData: true,\n        expandComment: true,\n        monitored: true,\n        skipDependent: true,\n        //only_true: true,\n        // filter: {\n        //   value: 1\n        // },\n        selectLastEvent: 'extend'\n      };\n\n      if (timeFrom || timeTo) {\n        params.lastChangeSince = timeFrom;\n        params.lastChangeTill = timeTo;\n      }\n\n      return this.request('trigger.get', params);\n    }\n\n    getHostAlerts(hostids, applicationids, options) {\n      let {minSeverity, acknowledged, count, timeFrom, timeTo} = options;\n      let params = {\n        output: 'extend',\n        hostids: hostids,\n        min_severity: minSeverity,\n        filter: { value: 1 },\n        expandDescription: true,\n        expandData: true,\n        expandComment: true,\n        monitored: true,\n        skipDependent: true,\n        selectLastEvent: 'extend',\n        selectGroups: 'extend',\n        selectHosts: ['host', 'name']\n      };\n\n      if (count && acknowledged !== 0 && acknowledged !== 1) {\n        params.countOutput = true;\n      }\n\n      if (applicationids && applicationids.length) {\n        params.applicationids = applicationids;\n      }\n\n      if (timeFrom || timeTo) {\n        params.lastChangeSince = timeFrom;\n        params.lastChangeTill = timeTo;\n      }\n\n      return this.request('trigger.get', params)\n      .then((triggers) => {\n        if (!count || acknowledged === 0 || acknowledged === 1) {\n          triggers = filterTriggersByAcknowledge(triggers, acknowledged);\n          if (count) {\n            triggers = triggers.length;\n          }\n        }\n        return triggers;\n      });\n    }\n  }\n\n  return ZabbixAPI;\n}\n\nfunction filterTriggersByAcknowledge(triggers, acknowledged) {\n  if (acknowledged === 0) {\n    return _.filter(triggers, (trigger) => trigger.lastEvent.acknowledged === \"0\");\n  } else if (acknowledged === 1) {\n    return _.filter(triggers, (trigger) => trigger.lastEvent.acknowledged === \"1\");\n  } else {\n    return triggers;\n  }\n}\n\nfunction isNotAuthorized(message) {\n  return (\n    message === \"Session terminated, re-login, please.\" ||\n    message === \"Not authorised.\" ||\n    message === \"Not authorized.\"\n  );\n}\n\nangular\n  .module('grafana.services')\n  .factory('zabbixAPIService', ZabbixAPIServiceFactory);\n"]}