{"version":3,"sources":["../../src/datasource-zabbix/zabbixCachingProxy.service.js"],"names":["ZabbixCachingProxyFactory","ZabbixCachingProxy","zabbixAPI","zabbixDBConnector","cacheOptions","dbConnector","cacheEnabled","enabled","ttl","cache","groups","hosts","applications","items","history","trends","macros","globalMacros","itServices","historyPromises","getHistory","callAPIRequestOnce","_","bind","getHistoryRequestHash","getHistoryDB","getDBQueryHash","getTrendsDB","getTrends","groupPromises","getGroupsOnce","getGroups","getRequestHash","hostPromises","getHostsOnce","getHosts","appPromises","getAppsOnce","getApps","itemPromises","getItemsOnce","getItems","itemByIdPromises","getItemsByIdOnce","getItemsByIDs","itServicesPromises","getITServicesOnce","getITService","macroPromises","getMacrosOnce","getMacros","globalMacroPromises","getGlobalMacrosOnce","getGlobalMacros","cacheObject","object_age","Date","now","timestamp","request","params","hash","isExpired","Promise","resolve","value","then","result","proxyRequest","groupids","hostids","appids","itemtype","itemids","promises","all","flatten","time_from","time_till","historyStorage","full_history","expired","filter","keyBy","item","itemid","length","grouped_history","groupBy","forEach","map","func","promiseKeeper","argsHashFunc","arguments","apply","args","requestStamp","arg","undefined","isArray","sort","toString","join","getHash","stamp","consolidateBy","intervalMs","angular","module","factory","String","prototype","i","chr","len","charCodeAt","indexBy"],"mappings":"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","file":"zabbixCachingProxy.service.js","sourcesContent":["import angular from 'angular';\nimport _ from 'lodash';\n\n// Use factory() instead service() for multiple datasources support.\n// Each datasource instance must initialize its own cache.\n\n/** @ngInject */\nfunction ZabbixCachingProxyFactory() {\n\n  class ZabbixCachingProxy {\n    constructor(zabbixAPI, zabbixDBConnector, cacheOptions) {\n      this.zabbixAPI = zabbixAPI;\n      this.dbConnector = zabbixDBConnector;\n      this.cacheEnabled = cacheOptions.enabled;\n      this.ttl          = cacheOptions.ttl || 600000; // 10 minutes by default\n\n      // Internal objects for data storing\n      this.cache = {\n        groups: {},\n        hosts: {},\n        applications: {},\n        items: {},\n        history: {},\n        trends: {},\n        macros: {},\n        globalMacros: {},\n        itServices: {}\n      };\n\n      this.historyPromises = {};\n\n      // Don't run duplicated history requests\n      this.getHistory = callAPIRequestOnce(_.bind(this.zabbixAPI.getHistory, this.zabbixAPI),\n                                           this.historyPromises, getHistoryRequestHash);\n\n      if (this.dbConnector) {\n        this.getHistoryDB = callAPIRequestOnce(_.bind(this.dbConnector.getHistory, this.dbConnector),\n                                               this.historyPromises, getDBQueryHash);\n        this.getTrendsDB = callAPIRequestOnce(_.bind(this.dbConnector.getTrends, this.dbConnector),\n                                              this.historyPromises, getDBQueryHash);\n      }\n\n      // Don't run duplicated requests\n      this.groupPromises = {};\n      this.getGroupsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getGroups, this.zabbixAPI),\n                                              this.groupPromises, getRequestHash);\n\n      this.hostPromises = {};\n      this.getHostsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getHosts, this.zabbixAPI),\n                                             this.hostPromises, getRequestHash);\n\n      this.appPromises = {};\n      this.getAppsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getApps, this.zabbixAPI),\n                                            this.appPromises, getRequestHash);\n\n      this.itemPromises = {};\n      this.getItemsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getItems, this.zabbixAPI),\n                                             this.itemPromises, getRequestHash);\n\n      this.itemByIdPromises = {};\n      this.getItemsByIdOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getItemsByIDs, this.zabbixAPI),\n                                                 this.itemPromises, getRequestHash);\n\n      this.itServicesPromises = {};\n      this.getITServicesOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getITService, this.zabbixAPI),\n                                                  this.itServicesPromises, getRequestHash);\n\n      this.macroPromises = {};\n      this.getMacrosOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getMacros, this.zabbixAPI),\n                                             this.macroPromises, getRequestHash);\n\n      this.globalMacroPromises = {};\n      this.getGlobalMacrosOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getGlobalMacros, this.zabbixAPI),\n                                                    this.globalMacroPromises, getRequestHash);\n    }\n\n    isExpired(cacheObject) {\n      if (cacheObject) {\n        let object_age = Date.now() - cacheObject.timestamp;\n        return !(cacheObject.timestamp && object_age < this.ttl);\n      } else {\n        return true;\n      }\n    }\n\n    /**\n     * Check that result is present in cache and up to date\n     * or send request to API.\n     */\n    proxyRequest(request, params, cacheObject) {\n      let hash = getRequestHash(params);\n      if (this.cacheEnabled && !this.isExpired(cacheObject[hash])) {\n        return Promise.resolve(cacheObject[hash].value);\n      } else {\n        return request(...params)\n        .then(result => {\n          cacheObject[hash] = {\n            value: result,\n            timestamp: Date.now()\n          };\n          return result;\n        });\n      }\n    }\n\n    getGroups() {\n      return this.proxyRequest(this.getGroupsOnce, [], this.cache.groups);\n    }\n\n    getHosts(groupids) {\n      return this.proxyRequest(this.getHostsOnce, [groupids], this.cache.hosts);\n    }\n\n    getApps(hostids) {\n      return this.proxyRequest(this.getAppsOnce, [hostids], this.cache.applications);\n    }\n\n    getItems(hostids, appids, itemtype) {\n      let params = [hostids, appids, itemtype];\n      return this.proxyRequest(this.getItemsOnce, params, this.cache.items);\n    }\n\n    getItemsByIDs(itemids) {\n      let params = [itemids];\n      return this.proxyRequest(this.getItemsByIdOnce, params, this.cache.items);\n    }\n\n    getITServices() {\n      return this.proxyRequest(this.getITServicesOnce, [], this.cache.itServices);\n    }\n\n    getMacros(hostids) {\n      // Merge global macros and host macros\n      let promises = [\n        this.proxyRequest(this.getMacrosOnce, [hostids], this.cache.macros),\n        this.proxyRequest(this.getGlobalMacrosOnce, [], this.cache.globalMacros)\n      ];\n\n      return Promise.all(promises).then(_.flatten);\n    }\n\n    getHistoryFromCache(items, time_from, time_till) {\n      var historyStorage = this.cache.history;\n      var full_history;\n      var expired = _.filter(_.keyBy(items, 'itemid'), (item, itemid) => {\n        return !historyStorage[itemid];\n      });\n      if (expired.length) {\n        return this.zabbixAPI.getHistory(expired, time_from, time_till).then(function(history) {\n          var grouped_history = _.groupBy(history, 'itemid');\n          _.forEach(expired, item => {\n            var itemid = item.itemid;\n            historyStorage[itemid] = item;\n            historyStorage[itemid].time_from = time_from;\n            historyStorage[itemid].time_till = time_till;\n            historyStorage[itemid].history = grouped_history[itemid];\n          });\n          full_history = _.map(items, item => {\n            return historyStorage[item.itemid].history;\n          });\n          return _.flatten(full_history, true);\n        });\n      } else {\n        full_history = _.map(items, function(item) {\n          return historyStorage[item.itemid].history;\n        });\n        return Promise.resolve(_.flatten(full_history, true));\n      }\n    }\n\n    getHistoryFromAPI(items, time_from, time_till) {\n      return this.zabbixAPI.getHistory(items, time_from, time_till);\n    }\n  }\n\n  return ZabbixCachingProxy;\n}\n\nangular\n  .module('grafana.services')\n  .factory('ZabbixCachingProxy', ZabbixCachingProxyFactory);\n\n/**\n * Wrap zabbix API request to prevent multiple calls\n * with same params when waiting for result.\n */\nfunction callAPIRequestOnce(func, promiseKeeper, argsHashFunc) {\n  return function() {\n    var hash = argsHashFunc(arguments);\n    if (!promiseKeeper[hash]) {\n      promiseKeeper[hash] = Promise.resolve(\n        func.apply(this, arguments)\n        .then(result => {\n          promiseKeeper[hash] = null;\n          return result;\n        })\n      );\n    }\n    return promiseKeeper[hash];\n  };\n}\n\nfunction getRequestHash(args) {\n  var requestStamp = _.map(args, arg => {\n    if (arg === undefined) {\n      return 'undefined';\n    } else {\n      if (_.isArray(arg)) {\n        return arg.sort().toString();\n      } else {\n        return arg.toString();\n      }\n    }\n  }).join();\n  return requestStamp.getHash();\n}\n\nfunction getHistoryRequestHash(args) {\n  let itemids = _.map(args[0], 'itemid');\n  let stamp = itemids.join() + args[1] + args[2];\n  return stamp.getHash();\n}\n\nfunction getDBQueryHash(args) {\n  let itemids = _.map(args[0], 'itemid');\n  let consolidateBy = args[3].consolidateBy;\n  let intervalMs = args[3].intervalMs;\n  let stamp = itemids.join() + args[1] + args[2] + consolidateBy + intervalMs;\n  return stamp.getHash();\n}\n\nString.prototype.getHash = function() {\n  var hash = 0, i, chr, len;\n  if (this.length !== 0) {\n    for (i = 0, len = this.length; i < len; i++) {\n      chr   = this.charCodeAt(i);\n      hash  = ((hash << 5) - hash) + chr;\n      hash |= 0; // Convert to 32bit integer\n    }\n  }\n  return hash;\n};\n\n// Fix for backward compatibility with lodash 2.4\nif (!_.keyBy) {_.keyBy = _.indexBy;}\n"]}